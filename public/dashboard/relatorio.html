<!DOCTYPE html>
<html lang="br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Umido - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="..\css\dashboard.css">
</head>
<body>
    
    
    <header class="i_header">
        <div class="container">
            <div class="logo"></div>
            <nav>
                <input type="text" placeholder="Buscar...">
                <button class="botao_buscar">Buscar</button>
            </nav>
            <div class="div_perfil">
                <div>
                     <h4 id="nome_usuario_dashboard"></h4>
          <h5 id="nivel_usuario_dashboard"></h5>
                </div>
                <img src="../assets/icons/user.png" style="width: 40px; height: 40px;" alt="perfil">
            </div>
        </div>
    </header>
    <div class="layout_principal">
        <div class="menu_lateral menu_expandido">
            <div class="botao_expandir" id="botao_expandir" onclick="botao_abrir_fechar_menu()">
                <img src="../assets/icons/seta.png" style="width: 20px; height: 20px;">
            </div>
            <ul class="itens_menu">
                 <li style="gap: 20px;" onclick = "window.location.href = 'geral.html'">
                    <img src="../assets/icons/grafico.png" style="width: 30px; height: 30px;">
                    <span>Painel Geral</span>
                </li>
                <li style="gap: 20px;" onclick = "window.location.href = 'relatorio.html'" class="ativo">
                    <img src="../assets/icons/grafico.png" style="width: 30px; height: 30px;">
                    <span>Relatórios</span>
                </li>
                <li style="gap: 20px;" onclick = "window.location.href = 'configuracao.html'" >
                    <img src="../assets/icons/configuracao.png" style="width: 30px; height: 30px;">
                    <span>Configurações</span>
                </li>
                 <a href="https://umido.atlassian.net/servicedesk/customer/portals">
          <li style="gap: 20px;" onclick="">
            <img src="../assets/icons/alert.png" style="width: 30px; height: 30px;">
            <span>Suporte</span>
          </li>
        </a>

                         <a href="../../Documentação/Manual usuario projeto Umido.pdf" download="Manual_usuario_projeto_Umido.pdf">
          <li style="gap: 20px;" onclick="">
            <img src="../assets/icons/icone download.png" style="width: 30px; height: 30px;">
            <span>Manual</span>
          </li>
        </a>
                <li style="gap: 20px;" onclick="window.location.href = '../index.html'">
                    <img src="../assets/icons/sair.png" style="width: 30px; height: 30px;">
                    <span>Sair</span>
            </ul>
        </div>
    
        <section class="conteudo_principal">
            <div>
                <select class="selecionar_unidade" id="selecionar_unidade" onchange="select_unidade()">
                    <option value="1">Unidade 1</option>
                    <option value="3">Unidade 3</option>
                    <option value="2">Unidade 2</option>
                    <option value="4">Unidade 4</option>
                </select>
                <button class="btn_add_unidade" id="btn_add_unidade" onclick="mostrar_modal_unidade()">Adicionar Unidade</button>
                <button class="btn_add_unidade" id="" onclick="">Exportar dados da Unidade</button>
            </div>
            <div class="cartao principal_g">
                <div class="indicadores" id="indicadores"></div>
                <div class="secao_monitoramento">
                    <div class="cartao">
                        <div class="titulo_grafico">Umidade media por Período</div>
                        <div class="container_grafico">
                            <canvas id="grafico_umidade"></canvas>
                        </div>
                    </div>
                    <div class="cartao">
                        <div class="titulo_sensores">Lista de áreas
                            <button id="botao_adicionar_sensor" onclick="mostrar_modal_adicionar_sensor()" class="botao_adicionar">solicitar novo Sensor</button>
                        </div>
                        <div class="lista_botoes">
                            <ul class="lista_sensores" id="lista_sensores"></ul>
                        </div>
                    </div>
                </div>
                <div style="width: 100%; height: 100%; display: grid ; grid-template-rows: 20px 1fr;">
                    <div class="titulo_grafico">ESTATÍSTICAS E ALERTAS DO MÊS</div>
                    <div class="graficos-mensais" id="graficos_mensais">
                        <div class="container_grafico_mensal">
                            <div class="graficos-semanas">
                                <canvas id="grafico_umidade_semana"></canvas>
                            </div>
                        </div>
                        <div class="graficos-alertas">
                            <canvas class="" id="grafico_alertas_pie"></canvas>
                        </div>
                        <div id="lista_area">
                        
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <div id="modal_sensor" class="modal_sensor">
        <div class="conteudo_modal">
            <span class="fechar_modal" onclick="fechar_modal()">&times;</span>
            <h2 id="titulo_modal_sensor">Sensor X</h2>
            <div class="metricas_sensor">
                <div class="cartao_metrica">
                    <h3>Umidade Atual</h3>
                    <div class="valor_metrica" id="umidade_sensor">--</div>
                </div>
                <div class="cartao_metrica">
                    <h3>Status</h3>
                    <div class="valor_metrica" id="status_sensor">--</div>
                </div>
            </div>
            <div class="grafico_sensor">
                <h3>Histórico de Umidade (24h)</h3>
                <canvas id="grafico_historico_sensor"></canvas>
            </div>
        </div>
    </div>
    
    <div id="modal_adicionar_sensor" class="modal">
        <div class="conteudo_modal">
            <span class="fechar_modal" id="fechar_modal" onclick="fechar_modal_adicionar_sensor()">&times;</span>
            <h2>Solicitar Novo Sensor</h2>
            <form id="formulario_adicionar_sensor">
                <div class="grupo_formulario">
                    <label for="nome_sensor">Nome da nova área:</label>
                    <input type="text" id="nome_sensor" required placeholder="Ex: Hectar 12">
                </div>
                <div class="grupo_formulario">
                    <label for="tipo_sensor">Tipo de Sensor:</label>
                    <select id="tipo_sensor" required>
                        <option value="umidade">Umidade</option>
                    </select>
                </div>
                <div class="botoes_formulario">
                    <button type="button" class="botao_cancelar" onclick="fechar_modal_adicionar_sensor()"
                        id="botao_cancelar">Cancelar</button>
                    <button type="submit" class="botao_salvar" onclick="botao_salvar_formulario()">Solicitar sensor para a nova área</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal_unidade" class="modal_unidade">
        <div class="conteudo_modal">
            <span class="fechar_modal" onclick="fechar_modal_unidade()">&times;</span>
            <h2 id="titulo_modal_sensor">Adicionar nova Unidade</h2>
            <form id="formulario_adicionar_unidade">
                <div class="grupo_formulario">
                    <label for="nome_sensor">Nome da Unidade</label>
                    <input type="text" id="nome_unidade"  placeholder="Ex: Unidade">
                </div>
                <div class="botoes_formulario">
                    <button type="button" class="botao_cancelar" onclick="fechar_modal_unidade()" id="botao_cancelar">Cancelar</button>
                    <button type="button" class="botao_salvar" onclick="botao_salvar_unidade()">Adicionar Unidade</button>
                </div>
            </form>
        </div>
    </div>
</body>
<script>
const idUsuario = sessionStorage.getItem("ID_USUARIO"); // Pega o ID do usuário logado ou usa 1 como padrão
    const nomeUsuario = sessionStorage.getItem("NOME_USUARIO") || "Usuário";
    const nivelAcesso = sessionStorage.getItem("NIVEL_DE_ACESSO");
    nome_usuario_dashboard.innerHTML = nomeUsuario;
  nivel_usuario_dashboard.innerHTML = nivelAcesso == 'admin' ? 'Administrador' : 'comum';
    var graficoUmidadeSemana
    var graficoAlertasPie 
    var graficoUmidadeMedia 

    // Função para buscar as unidades relacionadas ao usuário logado
  async function carregarUnidadesUsuario() {
  
  const response = await fetch("/usuarios/obterUnidades", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ idServer: idUsuario })
  });
  const unidades = await response.json();

  const select = document.getElementById("selecionar_unidade");
  select.innerHTML = ""; 

  unidades.forEach(unidade => {
    const option = document.createElement("option");
    option.value = unidade.id;
    option.textContent = unidade.nome;
    select.appendChild(option);
  });

  // Chama o restante da lógica para atualizar os gráficos e KPIs

}

let idUnidadeSelecionada = null;

// Chame ao carregar a página
carregarUnidadesUsuario();


let ultimo_grafico;

const modalAdicionarSensor = modal_adicionar_sensor;

const formularioAdicionarSensor = formulario_adicionar_sensor;


 function buscarUmidadePorSensor(){
    let idUnidade = selecionar_unidade.value

    fetch(`/relatorios/buscarUmidadePorSensor/${idUnidade}`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            
console.log(resposta)
            //  mostrar_modal_sensor(resposta)

          });
        }
      })};

 function buscarQuantidadeDeAlertas(){
    let idUnidade = selecionar_unidade.value

    fetch(`/relatorios/buscarQuantidadeDeAlertas/${idUnidade}`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            var sensor = resposta.map(item => item.sensor)
            var alerta =  resposta.map(item => item.alerta)
          
        
             criar_grafico_alertas_pie(sensor,alerta)
          });
        }
      })};

 function buscarUmidadeMediaUltimasSemanas(){
    let idUnidade = selecionar_unidade.value

    fetch(`/relatorios/buscarUmidadeMediaUltimasSemanas/${idUnidade}`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            var semana = resposta.map(item => item.umidade)
            
            
            criar_grafico_umidade_semana(semana)
            console.log(resposta)
          });
        }
      })};

 function buscarUmidadeMediaUnidade(){
    let idUnidade = selecionar_unidade.value

    fetch(`/relatorios/buscarUmidadeMediaUnidade/${idUnidade}`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            var mes = resposta.map(item => item.mes)
            var dados =  resposta.map(item => item.umidade)
          
            criar_grafico_geral(mes,dados)

          });
        }
      })};

 function buscarListaAlertas(){
    let idUnidade = selecionar_unidade.value

    fetch(`/relatorios/buscarListaAlertas/${idUnidade}`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            
            data = []

            var listaData = resposta.map(item => item.data_hora)
            var id = resposta.map(item => item.id_sensor)
            var umidade = resposta.map(item => item.umidade)
           
            criar_lista_alertas(id, data, umidade)
                console.log(resposta)
                // criar_lista_alertas(id, data, umidade)
                
                for(let i = 0; i < listaData.length; i++ ){
                    data += new Date(listaData[i])
                }
                console.log('lista',id,data,umidade)
            
        
          });
        }
      })};

function criar_lista_alertas(id, data, umidade){
    let html_lista =""
    for(let i =0;i<id;i++){
        html_lista += `
        <li style="display: grid; grid-template-columns: 1fr 1fr;  border-bottom: 1px solid black;">
            <div>Sensor ${id}</div>
            <div>${data}</div>
            <div>${umidade}</div>
        </li>
        ` 
    }
    let html = `
    <div class="container_grafico_mensal">
        <div class="cartao">
            <div class="titulo_grafico">ALERTAS</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr;">
                <div class="titulo_grafico">Sensor</div>
                <div class="titulo_grafico">Data</div>
            </div>
            <ul>
                ${html_lista}
            </ul>
        </div>
    </div>
    `
     lista_area.innerHTML = html
}

function criar_grafico_geral(mes,dados) {
    let contexto = document.getElementById('grafico_umidade').getContext('2d');

    for(let i = 0; i < 12 ;i++){
        if (mes[i] == 1){
            mes[i] = 'jan' 
        }else if (mes[i] == 2){
            mes[i] = 'fev' 
        }else if (mes[i] == 3){
            mes[i] = 'mar' 
        }else if (mes[i] == 4){
            mes[i] = 'abr'
        }else if (mes[i] == 5){
            mes[i] = 'mai'
        }else if (mes[i] == 6){
            mes[i] = 'jun' 
        }else if (mes[i] == 7){
            mes[i] = 'jul' 
        }else if (mes[i] == 8){
            mes[i] = 'ago' 
        }else if (mes[i] == 9){
            mes[i] = 'set' 
        }else if (mes[i] == 10){
            mes[i] = 'out' 
        }else if (mes[i] == 11){
            mes[i] = 'nov' 
        }else if (mes[i] == 12){
            mes[i] = 'dez' 
        }
    }


    graficoUmidadeMedia = new Chart(contexto, {
        type: "line",
        data: {
            labels:mes ,
            datasets: [
                {
                    label: "CRÍTICO",
                    data: [30, 30, 30, 30, 30, 30],
                    backgroundColor: 'rgba(255, 168, 255, 0.2)',
                    borderColor: 'rgba(255, 000, 000, 0.5)',
                    borderWidth: 2,
                    fill: true
                },
                 {
                    label: "ALERTA",
                    data: [40, 40, 40, 40, 40, 40],
                    backgroundColor: 'rgba(255, 168, 255, 0.2)',
                    borderColor: 'rgba(100, 208, 255, 0.9)',
                    borderWidth: 2,
                    fill: true
                },
                {
                    label: "Umidade (%)",
                    data: dados,
                    backgroundColor: 'rgba(0, 168, 255, 0.9)',
                    borderColor: 'rgba(0, 150, 255, 1)',
                    borderWidth: 2,
                    fill: false
                }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    suggestedMin: 0,
                        suggestedMax: 80,
                }
            }
        }
    });

}

let quantidade_alerta = 0
async function criar_kpis() {
  indicadores.innerHTML = "";
    //TROCAR ID DA EMPRESA AQUIIIIIIIIIIIIIIIIIIIII
  try {
    const response = await fetch(`/unidades/${idUnidadeSelecionada}/indicadores/${idUsuario}`);
    const dados = await response.json();
    console.log(dados);

    let dadosIndicadores = [
      [dados.quantidade_alerta, "incidentes", "(Mês atual)"],
      [dados.umidade_media + "%", "umidade média atual", "(Mês atual)"],
  
      [dados.sensores_desativados, "sensores desativados", ""],
      [dados.hora_atualizacao, dados.data_atualizacao, "última atualização"]
    ];

    for (let i = 0; i < dadosIndicadores.length; i++) {
      indicadores.innerHTML += `
        <div class="cartao">
            <div class="valor_indicador">${dadosIndicadores[i][0]}</div>
            <div class="descricao_indicador">${dadosIndicadores[i][1]}</div>
            <div class="info_adicional">${dadosIndicadores[i][2]}</div>
        </div>`;
    }
  } catch (error) {
    console.error("Erro ao buscar indicadores:", error);
  }
}

function criar_grafico_umidade_semana(semana){

    let contexto = document.getElementById('grafico_umidade_semana').getContext('2d');

    console.log('semana',semana)
 graficoUmidadeSemana = new Chart(contexto, {
        type: 'bar',
        data: {
            labels: ['1º semana','2º semana','3º semana','4º semana'],
            datasets: [{
                label: 'Umidade (%)',
                data: semana,
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                    title: {
                        display: true,
                        text: 'Umidade média das últimas semana',
                        color: '#000000',
                        font: {
                            Size: 150,
                        },
                           },
    }
        }
    });


}

function criar_grafico_alertas_pie(sensor,alerta){
 
    let contexto = document.getElementById('grafico_alertas_pie').getContext('2d');

    console.log(sensor,alerta)

    graficoAlertasPie = new Chart(contexto, {
        type: 'pie',
        data: {
            labels: sensor,
            datasets: [{
                label: 'quantidade de alertas',
                data: alerta,
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            plugins: {
                    title: {
                        display: true,
                        text: 'Áreas com alertas',
                        color: '#000000',
                        font: {
                            Size: 150,
                        },
                           },
    }
        },
})
};

function criar_grafico_modal_sensor(horas,dados) {

    const contexto = document.getElementById('grafico_historico_sensor').getContext('2d');
if (window.graficoHistoricoSensor) {
    window.graficoHistoricoSensor.destroy();
}


    window.graficoHistoricoSensor = new Chart(contexto, {
        type: 'line',
        data: {
            labels: horas,
            datasets: [{
                label: 'Umidade (%)',
                data: dados,
                borderColor: '#00a8ff',
                backgroundColor: 'rgba(0, 168, 255, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    min: Math.min(...dados) - 5,
                    max: Math.max(...dados) + 5
                }
            }
        }
    });
}

function mostrar_modal_sensor(posicao) {
    const modal = modal_sensor;
    const titulomodal = titulo_modal_sensor;
    const umidadeSensor = umidade_sensor;
    const statusSensor = status_sensor;

    titulomodal.textContent = dadosSensores[posicao][0];
    umidadeSensor.textContent = dadosSensores[posicao][2];  
    statusSensor.textContent = dadosSensores[posicao][4];

    modal.style.display = 'block';

    criar_grafico_modal_sensor(dadosSensores[posicao][5]);
}

function mostrar_modal_unidade(){
    modal_unidade.style.display = 'block';
}

function mostrar_modal_adicionar_sensor() {
    modalAdicionarSensor.style.display = 'block';
}

function fechar_modal() {
    modal_sensor.style.display = 'none';
}

function fechar_modal_unidade(){
    modal_unidade.style.display = 'none';
}

function fechar_modal_adicionar_sensor() {
    modalAdicionarSensor.style.display = 'none';
    formularioAdicionarSensor.reset();
}

function botao_salvar_unidade(){
    selecionar_unidade.innerHTML += `<option value="${nome_unidade.value}">${nome_unidade.value}</option>`
    modal_unidade.style.display = 'none';
    return false;

}

function botao_salvar_formulario() {
    const nome = nome_sensor.value;
    dadosSensores.push([nome, "Ativo", "100%", "10%", "Ativo", [0]])
    criar_kpis()
    fechar_modal_adicionar_sensor();
    return false;
}

function botao_abrir_fechar_menu() {
    const menuLateral = document.querySelector('.menu_lateral');
    menuLateral.classList.toggle('menu_expandido');
    botao_expandir.classList.toggle('girar');
}

function select_unidade() {
     const select = document.getElementById("selecionar_unidade");
  idUnidadeSelecionada = select.value; 
console.log(idUnidadeSelecionada)


 graficoUmidadeSemana.destroy()
 graficoAlertasPie.destroy() 
 graficoUmidadeMedia.destroy()


buscarQuantidadeDeAlertas()
buscarUmidadePorSensor()
 buscarUmidadeMediaUltimasSemanas()
buscarUmidadeMediaUnidade()
 buscarListaAlertas()
}

buscarQuantidadeDeAlertas()
buscarUmidadePorSensor()
 buscarUmidadeMediaUltimasSemanas()
buscarUmidadeMediaUnidade()
 buscarListaAlertas()
// criar_html_estatisticas_mes()
</script>
</html>

