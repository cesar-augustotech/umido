<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umido - Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="..\css\dashboard.css">
</head>

<body>
  <header class="i_header">
    <div class="container">
      <div class="logo"></div>
      <nav></nav>
      <div class="div_perfil">
        <div>
          <h4 id="nome_usuario_dashboard"></h4>
          <h5 id="nivel_usuario_dashboard">Comum</h5>
        </div>
        <img src="../assets/icons/user.png" style="width: 40px; height: 40px;" alt="perfil">
      </div>
    </div>
  </header>
  <div class="layout_principal">
    <div class="menu_lateral menu_expandido">
      <div class="botao_expandir" id="botao_expandir" onclick="botao_abrir_fechar_menu()">
        <img src="../assets/icons/seta.png" style="width: 20px; height: 20px;">
      </div>
      <ul class="itens_menu">
        <li style="gap: 20px;" onclick="window.location.href = 'geral.html'">
          <img src="../assets/icons/grafico.png" style="width: 30px; height: 30px;">
          <span>Painel</span>
        </li>
        <li style="gap: 20px;" onclick="window.location.href = 'relatorio.html'">
          <img src="../assets/icons/grafico.png" style="width: 30px; height: 30px;">
          <span>Relatórios</span>
        </li>
        <li style="gap: 20px;" onclick="window.location.href = 'configuracao.html'" class="ativo">
          <img src="../assets/icons/configuracao.png" style="width: 30px; height: 30px;">
          <span>Configurações</span>
        </li>
        <li style="gap: 20px;">
          <a href="https://umido.atlassian.net/servicedesk/customer/portals">
            <img src="../assets/icons/alert.png" style="width: 30px; height: 30px;">
            <span>Suporte</span>
          </a>
        </li>
        <li style="gap: 20px;">
          <a href="../../Documentação/Manual usuario projeto Umido.pdf" download="Manual_usuario_projeto_Umido.pdf">
            <img src="../assets/icons/icone download.png" style="width: 30px; height: 30px;">
            <span>Manual</span>
          </a>
        </li>
        <li style="gap: 20px;" onclick="logout()">
          <img src="../assets/icons/sair.png" style="width: 30px; height: 30px;">
          <span>Sair</span>
        </li>
      </ul>
    </div>

    <section class="conteudo_principal">
      <div class="cartao">
        <div class="titulo_grafico">
          <span>Gerenciamento de Usuários</span>
          <button class="botao_adicionar" onclick="abrirModalUsuario()" aria-label="Adicionar usuário">+ Adicionar Usuário</button>
        </div>
        <table style="width:100%; border-collapse: collapse;">
          <thead>
            <tr style="text-align:left; border-bottom: 2px solid #00a8ff;">
              <th style="padding: 10px;">Id</th>
              <th>Nome</th>
              <th>Email</th>
              <th>Unidades</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tabela_usuarios"></tbody>
        </table>
      </div>

      <!-- Modal Cadastro -->
      <div class="modal" id="modalUsuario">
        <div class="conteudo_modal">
          <span class="fechar_modal" onclick="fecharModalUsuario()" aria-label="Fechar modal">&times;</span>
          <h2>Cadastro de Funcionário</h2>
          <div class="grupo_formulario">
            <label for="ipt_nome">Nome</label>
            <input type="text" id="ipt_nome">
          </div>
          <div class="grupo_formulario">
            <label for="ipt_email">Email</label>
            <input type="email" id="ipt_email">
          </div>
          <div class="grupo_formulario">
            <label for="ipt_senha">Senha</label>
            <input type="password" id="ipt_senha">
          </div>
          <div class="grupo_formulario">
            <label for="sel_nivel">Nível de Acesso</label>
            <select id="sel_nivel">
              <option value="comum">Comum</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="grupo_formulario">
            <label>Unidades Vinculadas</label>
            <div id="checkboxes_unidades_cadastro"></div>
          </div>
          <button class="botao_salvar" onclick="salvarUsuario()" aria-label="Salvar usuário">Salvar</button>
          <button class="botao_cancelar" onclick="fecharModalUsuario()" aria-label="Cancelar">Cancelar</button>
        </div>
      </div>

      <!-- Modal Edição -->
      <div class="modal" id="modalUsuarioEditar">
        <div class="conteudo_modal">
          <span class="fechar_modal" onclick="fecharModalUsuarioEditar()" aria-label="Fechar modal">&times;</span>
          <h2>Cadastro de Funcionário</h2>
          <div class="grupo_formulario">
            <label for="ipt_nome_editar">Nome</label>
            <input type="text" id="ipt_nome_editar">
          </div>
          <div class="grupo_formulario">
            <label for="ipt_email_editar">Email</label>
            <input type="email" id="ipt_email_editar">
          </div>
          <div class="grupo_formulario">
            <label for="ipt_senha_editar">Senha</label>
            <input type="password" id="ipt_senha_editar">
          </div>
          <div class="grupo_formulario">
            <label for="sel_nivel_editar">Nível de Acesso</label>
            <select id="sel_nivel_editar">
              <option value="comum">Comum</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="grupo_formulario">
            <label>Unidades Vinculadas</label>
            <div id="checkboxes_unidades_editar"></div>
          </div>
          <button class="botao_cancelar" onclick="fecharModalUsuarioEditar()" aria-label="Cancelar">Cancelar</button>
          <div id="botaoEditar"></div>
        </div>
      </div>
    </section>
  </div>

</body>
<script>
  // Variáveis globais
  let usuarios = [];
  let unidadesDisponiveis = [];
  let idEditando;
  let usuariosIds = [];
  let listaCheckBoxCadastro = [];
  let listaCheckBoxEditar = [];

  const idUsuario = sessionStorage.getItem("ID_USUARIO");
  const nomeUsuario = sessionStorage.getItem("NOME_USUARIO") || "Usuário";
  const nivelAcesso = sessionStorage.getItem("NIVEL_DE_ACESSO");
  const idEmpresa = sessionStorage.getItem("EMPRESA_ID");

  nome_usuario_dashboard.innerHTML = nomeUsuario;
  nivel_usuario_dashboard.innerHTML = nivelAcesso == 'admin' ? 'Administrador' : 'Comum';

  // Carrega unidades disponíveis
  fetch("/usuarios/obterUnidades", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ idServer: idUsuario }),
  })
    .then(response => response.json())
    .then(unidadeUsuario => {
      unidadesDisponiveis = [];
      unidadeUsuario.forEach(unidadeAtual => {
        unidadesDisponiveis.push(unidadeAtual.nome);
      });
      gerarCheckboxes([], "checkboxes_unidades_cadastro", listaCheckBoxCadastro);
      gerarCheckboxes([], "checkboxes_unidades_editar", listaCheckBoxEditar);
    })
    .catch(function (resposta) {
      console.log(`#ERRO: ${resposta}`);
    });

  function botao_abrir_fechar_menu() {
    const menuLateral = document.querySelector('.menu_lateral');
    menuLateral.classList.toggle('menu_expandido');
    botao_expandir.classList.toggle('girar');
  }

  function obterDados() {
    tabela_usuarios.innerHTML = '';
    usuariosIds = [];
    fetch('/usuarios/obterDados', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ idEmpresa: idEmpresa })
    })
      .then(response => response.json())
      .then(data => {
        usuarios = data;
        tabela_usuarios.innerHTML = "";
        usuarios.forEach(usuarios => {
          const tr = document.createElement("tr");
          usuariosIds.push(usuarios.id)
          tr.innerHTML = `
            <td>${usuarios.id}</td>
            <td>${usuarios.nome}</td>
            <td>${usuarios.email}</td>
            <td id="valores_obter_unidades${usuarios.id}"></td>
            <td>
              <button class="botao_buscar" onclick="abrirModalUsuarioEditar(${usuarios.id})" aria-label="Editar usuário">Editar</button>
              <button class="botao_cancelar" onclick="removerUsuario(${usuarios.id})" aria-label="Remover usuário">Remover</button>
            </td>
          `;
          tabela_usuarios.appendChild(tr);
        });
      })
      .then(function () {
        for (let i = 0; i < usuariosIds.length; i++) {
          fetch("/usuarios/obterUnidades", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ idServer: usuariosIds[i] }),
          })
            .then(response => response.json())
            .then(unidadeUsuario => {
              const elemento = document.getElementById(`valores_obter_unidades${usuariosIds[i]}`);
              let nomes = '';
              unidadeUsuario.forEach(unidadeAtual => {
                nomes += unidadeAtual.nome + ', ';
              });
              elemento.innerHTML = nomes.slice(0, -2);
            })
            .catch(function (resposta) {
              console.log(`#ERRO: ${resposta}`);
            });
        }
      })
      .catch(err => {
        console.log("Erro ao obter dados:", err);
      });
  }

  function abrirModalUsuario() {
    idEditando = null;
    document.getElementById("ipt_nome").value = "";
    document.getElementById("ipt_email").value = "";
    document.getElementById("ipt_senha").value = "";
    document.getElementById("sel_nivel").value = "comum";
    gerarCheckboxes([], "checkboxes_unidades_cadastro", listaCheckBoxCadastro);
    document.getElementById("modalUsuario").style.display = "block";
  }

  function abrirModalUsuarioEditar(id) {
    // Busca dados do usuário para preencher o modal
    const usuario = usuarios.find(u => u.id === id);
    document.getElementById("ipt_nome_editar").value = usuario ? usuario.nome : "";
    document.getElementById("ipt_email_editar").value = usuario ? usuario.email : "";
    document.getElementById("ipt_senha_editar").value = "";
    document.getElementById("sel_nivel_editar").value = usuario && usuario.nivel_de_acesso ? usuario.nivel_de_acesso : "comum";
    // Busca unidades vinculadas
    fetch("/usuarios/obterUnidades", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ idServer: id }),
    })
      .then(response => response.json())
      .then(unidadeUsuario => {
        const selecionadas = unidadeUsuario.map(u => u.nome);
        gerarCheckboxes(selecionadas, "checkboxes_unidades_editar", listaCheckBoxEditar);
      });
    document.getElementById("modalUsuarioEditar").style.display = "block";
    botaoEditar.innerHTML = `<button class="botao_salvar" onclick="editarUsuario(${id})" aria-label="Editar usuário">Editar</button>`;
  }

  function fecharModalUsuario() {
    document.getElementById("modalUsuario").style.display = "none";
  }

  function fecharModalUsuarioEditar() {
    document.getElementById("modalUsuarioEditar").style.display = "none";
  }

  function salvarUsuario() {
    var nomeFetch = ipt_nome.value.trim();
    var emailFetch = ipt_email.value.trim();
    var senhaFetch = ipt_senha.value;
    var nivel_de_acessoFetch = sel_nivel.value;
    const unidadesSelecionadas = [...listaCheckBoxCadastro];

    // Validação básica
    if (!nomeFetch || !emailFetch || !senhaFetch) {
      alert("Preencha todos os campos obrigatórios.");
      return;
    }
    if (!emailFetch.includes('@')) {
      alert("Digite um email válido.");
      return;
    }

    fecharModalUsuario();

    fetch("/usuarios/salvarUsuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nomeServer: nomeFetch,
        emailServer: emailFetch,
        senhaServer: senhaFetch,
        nivel_de_acessoServer: nivel_de_acessoFetch,
        unidades: unidadesSelecionadas
      }),
    })
      .then(function (resposta) {
        if (resposta.ok) {
          obterDados();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
  }

  function editarUsuario(id) {
    var nomeFetch = ipt_nome_editar.value.trim();
    var emailFetch = ipt_email_editar.value.trim();
    var senhaFetch = ipt_senha_editar.value;
    var nivel_de_acessoFetch = sel_nivel_editar.value;
    const unidadesSelecionadas = [...listaCheckBoxEditar];

    if (!nomeFetch || !emailFetch) {
      alert("Preencha todos os campos obrigatórios.");
      return;
    }
    if (!emailFetch.includes('@')) {
      alert("Digite um email válido.");
      return;
    }

    fecharModalUsuarioEditar();

    fetch("/usuarios/editarUsuario", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        idServer: id,
        nomeServer: nomeFetch,
        emailServer: emailFetch,
        senhaServer: senhaFetch,
        nivel_de_acessoServer: nivel_de_acessoFetch,
        unidades: unidadesSelecionadas
      }),
    }).then(function (resposta) {
      if (resposta.ok) {
        obterDados();
      } else {
        throw "Houve um erro ao tentar realizar o cadastro!";
      }
    })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
      });
    botaoEditar.innerHTML = '';
  }

  function removerUsuario(id) {
    if (confirm("Deseja realmente remover este usuário?")) {
      fetch("/usuarios/removerUsuario", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ id }),
      }).then(function (resposta) {
        if (resposta.ok) {
          obterDados();
        } else {
          throw "Houve um erro ao tentar excluir um usuario";
        }
      })
        .catch(function (resposta) {
          console.log(`#ERRO: ${resposta}`);
        });
    }
  }

  // Função para gerar checkboxes de unidades
  function gerarCheckboxes(selecionadas, containerId, listaCheckBox) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    listaCheckBox.length = 0;
    unidadesDisponiveis.forEach(unidade => {
      const id = `chk_${containerId}_${unidade.replace(/\s+/g, "_")}`;
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = id;
      checkbox.value = unidade;
      checkbox.onchange = () => addListaCheck(checkbox, listaCheckBox);

      if (selecionadas && selecionadas.includes(unidade)) {
        checkbox.checked = true;
        listaCheckBox.push(unidade);
      }

      const label = document.createElement("label");
      label.htmlFor = id;
      label.innerText = unidade;
      label.style.marginRight = "15px";

      const div = document.createElement("div");
      div.appendChild(checkbox);
      div.appendChild(label);

      container.appendChild(div);
    });
  }

  function addListaCheck(checkbox, listaCheckBox) {
    if (checkbox.checked) {
      if (!listaCheckBox.includes(checkbox.value)) {
        listaCheckBox.push(checkbox.value);
      }
    } else {
      const index = listaCheckBox.indexOf(checkbox.value);
      if (index !== -1) {
        listaCheckBox.splice(index, 1);
      }
    }
  }

  function logout() {
    sessionStorage.clear();
    window.location.href = '../index.html';
  }

  // Chama obterDados ao carregar a página
  obterDados();
</script>
</html>